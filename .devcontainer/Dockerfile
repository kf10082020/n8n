# ‚úÖ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –±–∞–∑–∞
FROM node:18-bullseye-slim

# üß∞ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è n8n (ffmpeg, python, build tools)
RUN apt-get update && \
  apt-get install -y --no-install-recommends \
  ffmpeg \
  python3 \
  git \
  curl \
  build-essential \
  && apt-get clean && rm -rf /var/lib/apt/lists/*

# üìÇ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
WORKDIR /app

# üîΩ –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–≤–∞–∂–Ω–æ: Dockerfile –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ .dockerignore)
COPY . .

# üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN corepack enable && \
    pnpm install --frozen-lockfile --workspace-root && \
    pnpm build

# üìå –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ cli (—á—Ç–æ–±—ã `n8n` –ø–æ–ø–∞–ª –≤ $PATH)
RUN pnpm --filter n8n install -g

# üìÇ –ö–∞—Ç–∞–ª–æ–≥ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö (–º–æ–∂–Ω–æ –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ Railway)
VOLUME ["/home/node/.n8n"]

# üåç –ü–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Ä–∞–±–æ—Ç–∞–µ—Ç n8n
EXPOSE 5678

# üöÄ –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞
CMD ["n8n"]
